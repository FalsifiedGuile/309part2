<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<link rel="stylesheet" type="text/css" href="style.css">
		<meta HTTP-EQUIV="EXPIRES" CONTENT="-1">
		<title>Warehouse Wars MMORPG</title>
		<script language="javascript" src="jquery-3.3.1.min.js" > </script>
		<script language="javascript" src="game_data/renderFinish.js" > </script>
		<script src="lib/react.js"></script>
		<script src="lib/react-dom.js"></script>
		<script src="lib/babel.min.js"></script>

		<script type="text/babel" src="render/login.babel"></script>

		<script>
		function renderStage(stageArray){
			var img = document.createElement("img");
			var tableBody = $(document.createElement('tbody'));
			var row = $(document.createElement('tr'));
			//Create a prototype of the type of cell we want
			//In each cell we shall display the text "Cell"
			for (var i = 0; i < 20; i++)
			{
				var newRow = row.clone();
				tableBody.append(newRow);
				for (var j = 0; j < 20; j++){
					//console.log(stage.getActor(j, i).getName());
					var yLocation = i*20;
					var xLocation = j;
					var convertedLocation = yLocation + xLocation;
					switch(stageArray[convertedLocation]){
						case "p":
							img.src = document.getElementById('player').src;
							break;
						case "d":
							img.src = document.getElementById('monsterImage').src;
							break;
						case "w":
							img.src = document.getElementById('wallImage').src;
							break;
						case "b":
							img.src = document.getElementById('boxImage').src;
							break;
						case "s":
							img.src = document.getElementById('slimeImage').src;
							break;
						case "2":
							img.src = document.getElementById('player2').src;
							break;
						case "3":
							img.src = document.getElementById('player3').src;
							break;
						case "4":
							img.src = document.getElementById('player4').src;
							break;
						default:
							img.src = document.getElementById('blankImage').src;
							break;

					}

					if(img && img.style) {
							img.style.height = '40px';
							img.style.width = '40px';
					}
					var cell = $(document.createElement('td')).html(img);
					newRow.append(cell.clone());
				}
			}
			$('#stage').html(tableBody);
		}

		</script>
		<script type="text/javascript">
			var minNumber = 0;
			var maxNumber = 1000;
			var socket;
			var usr_id = -1;
			window.onbeforeunload = sendCloseConn;
			function sendCloseConn() {
			    socket.send(JSON.stringify({'jsonType':'closeConn','id':usr_id}));
			}


			$(function(){
				// socket = new WebSocket("ws://cslinux.utm.utoronto.ca:10001");
				socket = new WebSocket("ws://localhost:10311");
				socket.onopen = function (event) {
					$('#sendButton').removeAttr('disabled');
					console.log("connected");
				};

				socket.onclose = function (event) {
					//alert("closed code:" + event.code + " reason:" +event.reason + " wasClean:"+event.wasClean);
					socket.send(JSON.stringify({'id':usr_id}));
				};
				socket.onmessage = function (event) {
					var jsonThing=JSON.parse(event.data);

					if (jsonThing.jsonType == 'gg') {
						console.log(jsonThing);
						console.log("score: " + jsonThing.score);
						score = jsonThing.score;
						gameState = jsonThing.gameState;
						if (gameState == "win"){
							winner();
						} else if (gameState == "gameover"){
							gameover();
						}
					}
					if (jsonThing.jsonType == 'stage'){
						var stageArray = jsonThing.stage;
						renderStage(stageArray);
					}
					if (jsonThing.jsonType == 'init') {
						//console.log("USER spawn: " + jsonThing.player_id);
						usr_id = jsonThing.player_id;
					}



				}

				document.addEventListener('keydown', function(event) {
					var newCord;
					switch(event.keyCode){
						case 65:
							newCord = "west";
							break;
						case 68:
							newCord = "east";
							break;
						case 87:
							newCord = "north";
							break;
						case 88:
							newCord = "south";
							break;
						case 81:
							newCord = "north_west";
							break;
						case 69:
							newCord = "north_east";
							break;
						case 97:
							newCord = "south_west";
							break;
						case 99:
							newCord = "south_east";
							break;
						default:
							return;
					}
					socket.send(JSON.stringify({'jsonType':'direction', 'direction': newCord, 'id':usr_id}));
				});

			});
		</script>
	</head>
	<body bgcolor="ffffff">
		<center>
			<div id="Main"></div>
			<table class = "ww">
				<tr>
					<td> <div id="stage"> </div></td>
				</tr>
			</table>
			<table class="ww">
				<tr>
					<td> <img src="icons/blank.gif" id="blankImage" /> </td>
					<td> <img src="icons/emblem-package-2-24.png" id="boxImage" /> </td>
					<td> <img src="icons/face-devil-grin-24.png" id="monsterImage" /> </td>
					<td> <img src="icons/slime.png" id="slimeImage" /> </td>
					<td> <img src="icons/wall.jpeg" id="wallImage" /> </td>
					<td> <img src="icons/p1.jpg" id="player" /> </td>
					<td> <img src="icons/p2.png" id="player2" /> </td>
					<td> <img src="icons/p3.jpg" id="player3" /> </td>
					<td> <img src="icons/p4.jpg" id="player4" /> </td>
				</tr>
				<tr>
					<td> Empty <br/> Square </td>
					<td> Box </td>
					<td> Devil </td>
					<td> Slime </td>
					<td> Wall </td>
					<td> Player 1</td>
					<td> Player 2</td>
					<td> Player 3</td>
					<td> Player 4</td>
				</tr>
			</table>
		</center>
	</body>
</html>
